---
title: "Dev page for Shiny"
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
---


```{r load packages & functions, message=FALSE, warning=FALSE}
devtools::load_all()
library(dplyr)
```


```{r}
path <- system.file("extdata", package = "shinylipidcountr")

rawdata <- read_lipidview_files(path, clean_samples = FALSE)

metadata <- read_metadata(path, clean_samples = FALSE)
```


```{r}
data <- rawdata %>% 
  join_metadata(metadata) %>%
  join_istd_means() %>%
  #impute_rf() %>% 
  #apply_rf() %>%
  intensity_to_pmol() %>%
  blank_sub() %>% 
  #mutate(pmol_corr = pmol) %>% 
  #combine_dag_species() %>%
  pmol_to_uM() %>%
  sum_same_species()

# removes "x" in column "sample" & "sample_name". If sample names start with a 
# numeric, janitor puts automatically "x" before the sample name.
data <- data %>% mutate(sample = stringr::str_remove(sample, "x"),
                        sample = forcats::fct_inorder(species, ordered = NA),
                        sample_name = stringr::str_remove(sample_name, "x"),
                        sample_name = forcats::fct_inorder(species, ordered = NA))
```


```{r}
read_lipidxplorer_files <- function(path){
  
    readr::read_csv(path, show_col_types = FALSE, na = c("", "None")) %>%
    dplyr::filter(Class != "###") %>% 
    dplyr::select(Class, ChemicalSpecies, MolecularSpecies, LipidCategory, Mass, 
                  tidyselect::starts_with("Intensity"), 
                  tidyselect::starts_with("FattyAcidIntensity"))
  
}

clean_lipidxplorer_files <- function(rawdata, clean_samples = TRUE){
  
  if(clean_samples == TRUE){
    
    data <- rawdata %>% 
      janitor::clean_names() %>%
      tidyr::pivot_longer(
        cols = c(-class, -chemical_species, -molecular_species, -lipid_category,
                 -mass), 
        names_to = "sample", 
        values_to = "intensity")
    
    # separate fullms- and ms2-intensities
    # ms1 data in column 'intensity'
    # ms2 data in column 'fa_intensity'
    data <- data %>% 
      mutate(fatty_acid_comp = ifelse(stringr::str_detect(sample, "fatty"),
                                      "fa_intensity", "intensity"),
             sample = stringr::str_remove(sample, "fatty_acid_")) %>%
      tidyr::pivot_wider(id_cols = c(class, chemical_species, molecular_species,
                                     lipid_category, mass, sample),
                         names_from = fatty_acid_comp, values_from = intensity,
                         names_repair = "check_unique")
    
    # remove unnecessary strings from sample names for better reading 
    data <- data %>%  
      mutate(sample = stringr::str_remove(sample, "intensity_"),
             sample = stringr::str_remove(sample, "_s_mz_xml"))
    
  } else if(clean_samples == FALSE){
    
    data <- rawdata %>% 
      tidyr::pivot_longer(
        cols = c(-Class, -ChemicalSpecies, -MolecularSpecies, -LipidCategory,
                 -Mass),
        names_to = "Sample",
        values_to = "Intensity") %>% 
      janitor::clean_names()
    
    # separate fullms- and ms2-intensities
    # ms1 data in column 'intensity'
    # ms2 data in column 'fa_intensity'
    data <- data %>% 
      mutate(fatty_acid_comp = ifelse(stringr::str_detect(sample, "Fatty"),
                                      "fa_intensity", "intensity"),
             sample = stringr::str_remove(sample, "FattyAcid")) %>%
      tidyr::pivot_wider(id_cols = c(class, chemical_species, molecular_species,
                                     lipid_category, mass, sample),
                         names_from = fatty_acid_comp, values_from = intensity,
                         names_repair = "check_unique")
    
    # remove unnecessary strings from sample names for better reading 
    data <- data %>%  
      mutate(sample = stringr::str_remove(sample, "Intensity:"),
             sample = stringr::str_remove(sample, "-s.mzXML"))
    
  }
  
  # enhance internal standard species name with 'IS', so the function 
  # 'join_istd_means()' can detect internal standards
  data <- data %>%
    mutate(chemical_species = ifelse(lipid_category == "Internal standard",
                                     paste0("IS ", chemical_species), 
                                     chemical_species),
           molecular_species = ifelse(lipid_category == "Internal standard", 
                                      paste0("IS ", molecular_species), 
                                      molecular_species))
  # remove class name from species for better reading
  data <- data %>%  
    rename(species = chemical_species) %>% 
    mutate(species = ifelse(class != species,
                            stringr::str_remove_all(species, paste0(class, " ")),
                            species))
  
  return(data)
}

path_to_csv <- "C:/Users/christian/Mass_spectrometry/Spektren/QE/220712_XtrIL_AnaMartinVillalba/eval/eval-out.csv"

read_lipidxplorer_files() %>% 
  clean_lipidxplorer_files(clean_samples = TRUE) %>% 
  rename(scan_name = molecular_species) %>% 
  select(class, species, scan_name, sample, intensity) %>% 
  rbind(rawdata)
```


```{r sample match for LV and LX data}
lx_data <-  #input$file_lx$datapath %>%
  path_to_csv %>% 
          read_lipidxplorer_files() %>%
          clean_lipidxplorer_files(clean_samples = FALSE) %>%
          dplyr::rename(scan_name = molecular_species) %>%
          dplyr::select(class, species, scan_name, sample, intensity)

####
lv_data <- #files %>%
  list_txt_files("C:/Users/christian/R projects/LipidView_analysis/data/AMV/220712") %>% 
          read_txt_files() %>%
          shinylipidcountr::clean_txt_files(clean_samples = FALSE) %>%
          tidyr::pivot_longer(
            cols = c(-species, -class, -scan_name),
            names_to = "sample",
            values_to = "intensity")

get_samples(lv_data)
get_samples(lx_data)
```


```{r blank sub}
blank_sub <- function(raw_data){
  
  blank_data <- raw_data %>%
    dplyr::filter(sample %in% blank) %>% 
    dplyr::select(class, species, blank = sample, kon_pmol = pmol,
                  if(any(colnames(raw_data) == "scan_name")){"scan_name"})
  
  dplyr::left_join(raw_data, blank_data, by = c("class", "species", "blank",
                                                if(any(colnames(raw_data) == "scan_name")){"scan_name"})) %>%
    dplyr::mutate(pmol_corr = pmol - kon_pmol,
                  pmol_corr = ifelse(pmol_corr < 0, 0, pmol_corr)) %>%
    dplyr::filter(!sample %in% blank) %>% 
    dplyr::select(-blank, -kon_pmol)

}
```


```{r}
raw_data <- system.file("extdata", package = "shinylipidcountr") %>% 
  list_txt_files() %>% 
  read_txt_files() %>%
  clean_txt_files(clean_samples = FALSE) %>%
  tidyr::pivot_longer(
    cols = c(-species, -class, -scan_name),
    names_to = "sample",
    values_to = "intensity") %>% 
  join_metadata(metadata) %>%
  join_istd_means() %>%
  intensity_to_pmol()

meta_queue <- metadata %>%
    dplyr::filter(class == "blank") %>%
    dplyr::select(-class, -rf_values) %>%
    tidyr::pivot_longer(everything(),
                        names_to = "sample",
                        values_to = "blank")

exp_queue <- raw_data %>% 
  select(sample) %>% 
  unique()

```


```{r}
## LipidXplorer
raw_data_lx <-  
  system.file("extdata", "lx-out.csv", package = "shinylipidcountr") %>% 
  read_lipidxplorer_files() %>%
  clean_lipidxplorer_files(clean_samples = FALSE) %>%
          dplyr::rename(scan_name = molecular_species) %>%
          dplyr::select(class, species, scan_name, sample, intensity)

## LipidView
raw_data_lv <- 
  system.file("extdata", package = "shinylipidcountr") %>% 
  list_txt_files() %>%
  read_txt_files() %>%
  clean_txt_files(clean_samples = FALSE) %>% 
  tidyr::pivot_longer(
    cols = c(-species, -class, -scan_name),
    names_to = "sample",
    values_to = "intensity")


# If samples names from LipidView and LipidXplorer are not the same
# check_sample_names-function will stop the process!
check_sample_names(lv_data, lx_data)

data <- rbind(lv_data, lx_data)
```


```{r}
data_blank <- test_raw_data %>% 
  join_metadata(test_metadata) %>%
  join_istd_means() %>%
  intensity_to_pmol() %>%
  blank_sub() 

raw_data <- test_raw_data %>% 
  join_metadata(test_metadata) %>%
  join_istd_means() %>%
  intensity_to_pmol() %>%
  dplyr::filter(!stringr::str_detect(sample, "Kon A")) %>% 
  blank_sub() 

data_omit_blank <- test_raw_data %>% 
  join_metadata(test_metadata) %>%
  join_istd_means() %>%
  intensity_to_pmol() %>%
  mutate(pmol_corr = pmol) %>%
  select(-blank)
```


```{r}
blank_sub <- function(raw_data){

  blank_data <- raw_data %>%
    dplyr::filter(sample %in% blank) %>%
    dplyr::select(class, species, blank = sample, kon_pmol = pmol,
                  if(any(colnames(raw_data) == "scan_name")){"scan_name"})
  
  if(nrow(blank_data) == 0){
    stop("No blanks in raw data detected. Look for ", 
         unique(raw_data$blank),
         " in your raw data.")
  }

  dplyr::left_join(raw_data, blank_data, by = c("class", "species", "blank",
                                                if(any(colnames(raw_data) == "scan_name")){"scan_name"})) %>%
    dplyr::mutate(pmol_corr = pmol - kon_pmol,
                  pmol_corr = ifelse(pmol_corr < 0, 0, pmol_corr)) %>%
    dplyr::filter(!sample %in% blank) %>%
    dplyr::select(-blank, -kon_pmol)

}
```


```{r}
LipidomicsData <- R6::R6Class("LipidomicsData",
                              public = list(
                                rawdata = data.frame(),
                                metadata = data.frame()
                              )
)
LipidomicsData$set("public", "rawdata", test_raw_data)
LipidomicsData$set("public", "metadata", test_metadata)

test <- LipidomicsData$new()

test$rawdata <- test_raw_data

test$rawdata <- test_raw_data %>% join_metadata(test$metadata)
```


```{r}
MyBankAccount <- R6::R6Class(
  "MyBankAccount",
  public = list(
    balance = 0,
    deposit = function(x = 0){
      
      cat("Old balance: ", self$balance, "\n")
      
      self$balance <- self$balance + x
      
      cat("New balance: ", self$balance)
      
      invisible(self$balance)
    },
    withdraw = function(x = 0){
      stopifnot((self$balance - x) >= 0, x >= 0)
      
      cat("Old balance: ", self$balance, "\n")
       
      self$balance <- self$balance - x
      
      cat("New balance: ", self$balance)
      
      invisible(self$balance)
    },
    initialize = function(balance) {
      stopifnot(is.numeric(balance), balance >= 0)
      
      self$balance <- balance
    }
  )
)

bank <- MyBankAccount$new(balance = 0)
bank$deposit(10)
bank$withdraw(10)
```

